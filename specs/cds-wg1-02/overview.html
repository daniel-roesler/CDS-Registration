<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Linux Foundation Energy - Connected Data Specification (CDS) - Registration Working Group (WG1) - Specifications - cds-wg1-02 - Client Registration - Overview">
        <link rel="icon" type="image/png" href="/CDS-Registration/assets/favicon.png">
        <meta name="robots" content="noindex, nofollow"/>
        <title>CDS-WG1 - CDS-WG1 - 02 Client Registration - Overview</title>
        <link href="/CDS-Registration/assets/bootstrap-5.1.3-dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            /* Permalink styling */
            .permalink {
                text-decoration:none;
                font-size: 60%;
                display: inline-block;
                vertical-align: top;
                padding-top: 0.4em;
            }
            /* Code section styling */
            pre.highlight {
                background-color: #eee;
                padding: 0.5em;
            }
            /* SVG icons (based on https://github.com/diafygi/svg-font-to-svg-sprite-converter)
               Example (put "svgicons: fa-link, fa-plus-circle" in front matter):
               <svg class="svgicon"><use href="#fa-link"/></svg>
               <svg class="svgicon"><use href="#fa-plus-circle"/></svg>
            */
            #svgicon-defs{
                display: none;
            }
            .svgicon {
                overflow: visible !important;
                height: 0.7em;
                width: 0.7em;
                fill:currentColor;
            }
            /* Remove main column margin when printing (so content fills the full page width) */
            @media print {
                .container { max-width: 100% !important; }
            }
        </style>
    </head>
    <body>
        <!-- SVG Icons (see comment in css above on how to use) -->
        <svg id="svgicon-defs" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <symbol id="fa-external-link" viewBox="0 0 1792 1792" overflow="visible">
    <path d="M1408 928v320q0 119 -84.5 203.5t-203.5 84.5h-832q-119 0 -203.5 -84.5t-84.5 -203.5v-832q0 -119 84.5 -203.5t203.5 -84.5h704q14 0 23 9t9 23v64q0 14 -9 23t-23 9h-704q-66 0 -113 47t-47 113v832q0 66 47 113t113 47h832q66 0 113 -47t47 -113v-320q0 -14 9 -23t23 -9h64q14 0 23 9t9 23zM1792 64v512q0 26 -19 45t-45 19t-45 -19l-176 -176l-652 652q-10 10 -23 10t-23 -10l-114 -114q-10 -10 -10 -23t10 -23l652 -652l-176 -176q-19 -19 -19 -45t19 -45t45 -19h512q26 0 45 19t19 45z"></path>
</symbol>

                
                
            </defs>
        </svg>

        <!-- Non-production Warning -->
        <div id="non-prod-warning" class="bg-danger text-light text-center p-2 d-none">
            <strong>
                WARNING: THIS IS A DEVELOPMENT VERSION OF THE CDS-WG1 WEBSITE
                <span class="d-inline-block">
                    (this message does not appear on
                    <a class="text-light" href="https://cds-registration.lfenergy.org">cds-registration.lfenergy.org</a>)
                </span>
            </strong>
        </div>
        <script>
            if (window.location.hostname.indexOf("cds-registration.lfenergy.org") === -1) {
                document.getElementById("non-prod-warning").classList.remove("d-none");
            }
        </script>

        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <a
                    class="navbar-brand"
                    href="/CDS-Registration/"
                    >CDS-WG1</a>
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#header"
                    aria-controls="header"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="header">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a
                                class="nav-link"
                                
                                href="/CDS-Registration/"
                                >Home</a>
                        </li>
                        <li class="nav-item">
                            <a
                                class="nav-link"
                                
                                href="/CDS-Registration/use-cases"
                                >Use Cases</a>
                        </li>
                        <li class="nav-item">
                            <a
                                class="nav-link active text-decoration-underline"
                                
                                href="/CDS-Registration/specs"
                                >Specifications</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://github.com/lfe-cds/CDS-Registration/tree/main/meetings" target="_blank"
                                >Meeting Minutes
                                <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <div role="main" class="container pt-3 pb-5">
            <div class="row">
                <div class="col">
                    <p><a href="/CDS-Registration/">Home</a> / <a href="/CDS-Registration/specs">Specifications</a> / <a href="/CDS-Registration/specs/cds-wg1-02"><code class="language-plaintext highlighter-rouge">cds-wg1-02</code> - Client Registration</a> / Overview</p>

<h1 id="client-registration---overview">Client Registration - Overview</h1>

<p>This is a summary overview of the <a href="/CDS-Registration/specs/cds-wg1-02"><code class="language-plaintext highlighter-rouge">cds-wg1-02</code></a> specification, which defines how utilities and other central grid entities (‚ÄúServers‚Äù) can provide secure, managed connectivity with external entities (‚ÄúClients‚Äù).
External entities could be anyone, including enterprise customers, vendors, energy service providers, tech companies, and more.
The goal of this specification is to define a standardized way for utilities and other central grid entities to offer secure, streamlined, and automated connections to the external organizations with which they are working.</p>

<p>This specification defines protocols for registration, communication, secrets management, and secure data exchange, which makes it an ideal ‚Äúoff-the-shelf‚Äù solution for utilities and other central entities to use to initially establish secure connections to external entities.
Then, once a secure connection is established, other protocols (e.g. demand response signals, energy data exchange, etc.) can use that secure connection as needed for the specific use case.</p>

<p>For example, a utility could deploy a Server that implements this specification where demand response providers can register, submit documents, be reviewed, approved, and get issued access tokens in a standardized and scalable manner.</p>

<p>Additionally, this specification can be used and referenced by other specifications as the means by which their protocols can initially setup a secure connection.</p>

<h2 id="background-">Background <a id="background" href="#background" class="permalink">üîó</a></h2>

<p>Utilities and other central grid entities are increasingly needing to digitally interact with their vendors, service providers, customers, and other external organizations.
Many of these digital interactions (communication, data exchange, control systems, etc.) are sensitive and require secure connections to work.
However, initially setting up those secure connections in many cases is currently done using ad-hoc and manual processes that do not scale.</p>

<p>Therefore, to enable scaling the number of external secure connections needed by utilities and other central grid entities, an automated process for registering, onboarding, and maintaining these secure connections must be standardized.
This specification‚Äôs goal is to define that standard.</p>

<h2 id="technical-summary-">Technical Summary <a id="technical-summary" href="#technical-summary" class="permalink">üîó</a></h2>

<p>The <a href="/CDS-Registration/specs/cds-wg1-02"><code class="language-plaintext highlighter-rouge">cds-wg1-02</code></a> specification is fundamentally an extension of the <a href="https://oauth.net">OAuth</a> specifications, which have been used to great success in many other industries for secure connectivity.
In addition to building on OAuth‚Äôs protocols, the specification also defines additional protocols for Servers to manage Client registrations, messaging, credentials, and secure file transfers.</p>

<p>First, the specification defines how a utility or other central entity (called a ‚ÄúServer‚Äù) can <a href="/CDS-Registration/specs/cds-wg1-02#auth-server-metadata">publish metadata</a> about how an external entity (called a ‚ÄúClient‚Äù) can register with the server.
The process for publishing Server metadata builds on both CDS‚Äôs <a href="/CDS-Registration/specs/cds-wg1-02"><code class="language-plaintext highlighter-rouge">cds-wg1-01</code></a> (‚ÄúServer Metadata‚Äù) and OAuth‚Äôs <a href="https://www.rfc-editor.org/rfc/rfc8414">RFC 8414</a> (‚ÄúAuthorization Server Metadata‚Äù).
It also defines how Servers can describe the functionality they offer (called ‚ÄúScope Descriptions‚Äù) and disclose any requirements or steps for Client registration and onboarding (called ‚ÄúRegistration Requirements‚Äù).</p>

<p>Next, the specification defines protocols for <a href="/CDS-Registration/specs/cds-wg1-02#client-registration-process">Client registration</a> and <a href="/CDS-Registration/specs/cds-wg1-02#clients-api">Client management</a>.
Client registration is based on OAuth‚Äôs <a href="https://www.rfc-editor.org/rfc/rfc7591">RFC 7591</a> (‚ÄúDynamic Client Registration Protocol‚Äù).
The Client management protocol also defines how Servers can allow Client administrators to manage and use multiple Client objects via the <a href="/CDS-Registration/specs/cds-wg1-02#scopes-client-admin">Client Admin Scope</a> and <a href="/CDS-Registration/specs/cds-wg1-02#scopes-grant-admin">Grant Admin Scope</a>.
These protocols allow for Servers to automate and scale the management of potentially high numbers of connected Clients for a diverse set of use cases.</p>

<p>Next, the specification defines a protocol for <a href="/CDS-Registration/specs/cds-wg1-02#messages-api">messaging</a> between Servers and Clients.
This allows for Servers to securely communicate with their connected Clients in a standardized manner, as opposed to using insure and unstructured methods (e.g. e-mail) or proprietary methods (e.g. a third-party hosted vendor solution).</p>

<p>Next, the specification defines a protocol for <a href="/CDS-Registration/specs/cds-wg1-02#credentials-api">credential handling</a>, not only intended for managing and rotating Client secrets that can be used for the various APIs defined in the specification, but also potentially for managing credentials for other protocols that use or reference this specification.
This allows for Servers to securely issue and manage access tokens, secrets, and other highly sensitive credentials for their connected Clients.
Clients are also able to revoke and re-issue credentials, allowing for seamless and automated secret token rotation.</p>

<p>Next, the specification defines a protocol for <a href="/CDS-Registration/specs/cds-wg1-02#grants-api">managing access grants</a>, so that Clients can see what authorizations or access they‚Äôve been granted.
This allows Servers to provide visibility of access to Clients, so that Clients may organize and self-manage the various grants they‚Äôve been given in an automated manner.</p>

<p>Finally, the specification defines a protocol for securely sharing <a href="/CDS-Registration/specs/cds-wg1-02#server-provided-files-api">server-provided files</a>, so that Servers can securely share arbitrary use-case specific files with Clients.
This protocol is intended to be used for ad-hoc or one-time files (e.g. sharing a certificate during a Client onboarding process).
For structured datasets or regularly scheduled transfers of bulk data, Servers are recommended to use other protocols (that could reference this specification for establishing connectivity) that are more fit for purpose, since the included secure file sharing protocol does not have complex bulk data features, such as versioning, folder structures, deltas, etc.</p>

<p>Overall, the combination of protocols defined in this specification provides an ‚Äúoff-the-shelf‚Äù technical solution that can be freely referenced and implemented by utilities and other central entities to meet their needs for establishing and managing secure connectivity with external entities.</p>

<h2 id="api-overview-">API Overview <a id="api-overview" href="#api-overview" class="permalink">üîó</a></h2>

<p>Below are the web Application Programming Interface (‚ÄúAPI‚Äù) endpoints defined in <a href="/CDS-Registration/specs/cds-wg1-02"><code class="language-plaintext highlighter-rouge">cds-wg1-02</code></a>.</p>

<p><strong>NOTE:</strong> The below URLs are examples only, since each Server sets their own URLs for the specification‚Äôs required endpoints and includes them in their <a href="/CDS-Registration/specs/cds-wg1-02#auth-server-metadata-format">Metadata object</a>.</p>

<h4 id="metadata-apis-">Metadata APIs <a id="api-metadata" href="#api-metadata" class="permalink">üîó</a></h4>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#auth-server-metadata-url">/.well-known/cds-server-metadata.json</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-cds-server-metadata">example</a>] -
The CDS Server Metadata endpoint (from <a href="/CDS-Registration/specs/cds-wg1-01"><code class="language-plaintext highlighter-rouge">cds-wg1-01</code></a>) that is extended to include the <code class="language-plaintext highlighter-rouge">oauth</code> capability.</p>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#auth-server-metadata-format">/.well-known/oauth-authorization-server</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-auth-server-metadata">example</a>] -
The OAuth Authorization Server Metadata endpoint that is extended to include various CDS data fields.</p>

<h4 id="client-apis-">Client APIs <a id="api-clients" href="#api-clients" class="permalink">üîó</a></h4>

<p><span class="badge bg-warning text-dark">POST</span>
<a href="/CDS-Registration/specs/cds-wg1-02#registration-request">/oauth/client-registration</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-client-registration">example</a>] -
Registration endpoint for Clients based on OAuth‚Äôs Dynamic Client Registration Protocol.</p>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#clients-list">/cds-api/v1/clients</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-clients-list">example</a>] -
Lists <a href="/CDS-Registration/specs/cds-wg1-02#client-format">Client</a> objects that have been registered.</p>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#clients-get">/cds-api/v1/clients/<em>&lt;clientId&gt;</em></a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-client-get">example</a>] -
Returns an individual <a href="/CDS-Registration/specs/cds-wg1-02#client-format">Client</a> object.</p>

<p><span class="badge bg-warning text-dark">PUT</span>
<a href="/CDS-Registration/specs/cds-wg1-02#clients-modify">/cds-api/v1/clients/<em>&lt;clientId&gt;</em></a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-client-modify">example</a>] -
Modifies an individual <a href="/CDS-Registration/specs/cds-wg1-02#client-format">Client</a> object.</p>

<h4 id="messages-apis-">Messages APIs <a id="api-messages" href="#api-messages" class="permalink">üîó</a></h4>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#messages-list">/cds-api/v1/messages</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-messages-list">example</a>] -
Lists <a href="/CDS-Registration/specs/cds-wg1-02#message-format">Messages</a> for a Client.</p>

<p><span class="badge bg-warning text-dark">POST</span>
<a href="/CDS-Registration/specs/cds-wg1-02#messages-create">/cds-api/v1/messages</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-message-create">example</a>] -
Creates a new <a href="/CDS-Registration/specs/cds-wg1-02#message-format">Message</a> from the Client to the Server.</p>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#messages-get">/cds-api/v1/messages/<em>&lt;messageId&gt;</em></a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-message-get">example</a>] -
Returns an individual <a href="/CDS-Registration/specs/cds-wg1-02#message-format">Message</a> object.</p>

<p><span class="badge bg-warning text-dark">PATCH</span>
<a href="/CDS-Registration/specs/cds-wg1-02#messages-modify">/cds-api/v1/messages/<em>&lt;messageId&gt;</em></a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-message-modify">example</a>] -
Modifies an individual <a href="/CDS-Registration/specs/cds-wg1-02#message-format">Message</a> object.</p>

<h4 id="credentials-apis-">Credentials APIs <a id="api-credentials" href="#api-credentials" class="permalink">üîó</a></h4>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#credentials-list">/cds-api/v1/credentials</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-credentials-list">example</a>] -
Lists <a href="/CDS-Registration/specs/cds-wg1-02#credentials-format">Credentials</a> for a Client.</p>

<p><span class="badge bg-warning text-dark">POST</span>
<a href="/CDS-Registration/specs/cds-wg1-02#credentials-create">/cds-api/v1/credentials</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-credentials-create">example</a>] -
Creates a new <a href="/CDS-Registration/specs/cds-wg1-02#credentials-format">Credential</a> object.</p>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#credentials-get">/cds-api/v1/credentials/<em>&lt;credentialId&gt;</em></a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-credentials-get">example</a>] -
Returns an individual <a href="/CDS-Registration/specs/cds-wg1-02#credentials-format">Credential</a> object.</p>

<p><span class="badge bg-warning text-dark">PATCH</span>
<a href="/CDS-Registration/specs/cds-wg1-02#credentials-modify">/cds-api/v1/credentials/<em>&lt;credentialId&gt;</em></a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-credentials-modify">example</a>] -
Modifies an individual <a href="/CDS-Registration/specs/cds-wg1-02#credentials-format">Credential</a> object.</p>

<h4 id="grants-apis-">Grants APIs <a id="api-grants" href="#api-grants" class="permalink">üîó</a></h4>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#grants-list">/cds-api/v1/grants</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-grants-list">example</a>] -
Lists <a href="/CDS-Registration/specs/cds-wg1-02#grant-format">Grants</a> for a Client.</p>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#grants-get">/cds-api/v1/grants/<em>&lt;grantId&gt;</em></a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-grants-get">example</a>] -
Returns an individual <a href="/CDS-Registration/specs/cds-wg1-02#grant-format">Grant</a> object.</p>

<p><span class="badge bg-warning text-dark">PATCH</span>
<a href="/CDS-Registration/specs/cds-wg1-02#grants-modify">/cds-api/v1/grants/<em>&lt;grantId&gt;</em></a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-grants-modify">example</a>] -
Modifies an individual <a href="/CDS-Registration/specs/cds-wg1-02#grant-format">Grant</a> object.</p>

<h4 id="server-provided-files-apis-">Server-Provided Files APIs <a id="api-server-provided-files" href="#api-server-provided-files" class="permalink">üîó</a></h4>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#server-provided-files-list">/cds-api/v1/server-provided-files</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-server-provided-files-list">example</a>] -
Lists <a href="/CDS-Registration/specs/cds-wg1-02#server-provided-files-format">Server-Provided Files</a> for a Client.</p>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#server-provided-files-get">/cds-api/v1/server-provided-files/<em>&lt;fileId&gt;</em></a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-server-provided-files-get">example</a>] -
Returns an individual <a href="/CDS-Registration/specs/cds-wg1-02#server-provided-files-format">Server-Provided File</a> object (metadata and file details for the Server-Provided File).</p>

<p><span class="badge bg-success">GET</span>
<a href="/CDS-Registration/specs/cds-wg1-02#server-provided-files-download">/cds-api/v1/server-provided-files/<em>&lt;fileId&gt;</em>/download</a>
[<a href="/CDS-Registration/specs/cds-wg1-02#example-server-provided-files-download">example</a>] -
Returns the raw data for an individual <a href="/CDS-Registration/specs/cds-wg1-02#server-provided-files-format">Server-Provided File</a> object.</p>

<h2 id="examples-">Examples <a id="examples" href="#examples" class="permalink">üîó</a></h2>

<p>Here are some examples of how to programmatically interact with a Server‚Äôs APIs using <code class="language-plaintext highlighter-rouge">curl</code> and <code class="language-plaintext highlighter-rouge">jq</code> from the command line.</p>

<h4 id="example-registering-a-client-">Example: Registering a Client <a id="example-registering" href="#example-registering" class="permalink">üîó</a></h4>

<p>How to register with a CDS Server for a variety of scopes.</p>

<details style="margin-bottom:2em;">
<summary>Show example</summary>
<pre class="highlight">
<code>
# Start with your CDS Server Metadata's well-known URL
CDS_METADATA_URL="https://cdsserver123.example.com/.well-known/cds-server-metadata.json"

# Get the OAuth Authorization Server Metadata URL from the CDS Server Metadata
OAUTH_METADATA_URL=$(curl -v "$CDS_METADATA_URL" | jq -r ".oauth_metadata")

# See the OAuth Authorization Server Metadata

curl -v "$OAUTH_METADATA_URL" | jq "."
{
    ...
    "cds_registration_fields": {...},   # Reference for any required registration fields
    ...
    "cds_scope_descriptions": {...},    # Descriptions of scopes supported, along with any registration requirements
    ...
    "registration_endpoint": "...",     # Where to register via API
    ...
    "scopes_supported": [...],          # The list of supported scopes for this CDS Server
    ...                                 # (e.g. "client_admin grant_admin server_provided_files customer_data")
}
# (determine which scopes and registration requirements you want for registration)
SCOPES_TO_REGISTER="client_admin grant_admin server_provided_files customer_data"

# Submit a OAuth Dynamic Client Registration
# (add any additional registration fields to the submitted json)
REGISTRATION_ENDPOINT=$(curl -v "$OAUTH_METADATA_URL" | jq -r ".registration_endpoint")
curl -v \
    --data-raw "{
        \"client_name\": \"Example Energy Audit Services\",
        \"client_uri\": \"https://example.com/\",
        \"scope\": \"$SCOPES_TO_REGISTER\"
    }" \
    "$REGISTRATION_ENDPOINT" \
    | jq "."
{
    ...
    "client_id": "aaaaaaaaaa",
    ...
    "client_secret": "bbbbbbbbbbbbbbb",
    ...
    "scope": "client_admin",  # The Server creates multiple Client objects based on your registration
    ...                       # and only returns the main client_admin Client object as a response.
                              # Use the Clients API to manage the other Client objects that were created.
}

# You have now registered! Save the client_id and client_secret for use in other examples
CLIENT_ID="aaaaaaaaaa"
CLIENT_SECRET="bbbbbbbbbbbbbbb"
</code>
</pre>
</details>

<h4 id="example-loading-the-list-of-client-objects-">Example: Loading the list of Client objects <a id="example-load-clients" href="#example-load-clients" class="permalink">üîó</a></h4>

<p>After registering, you can load the list of Client objects created from your registration request.</p>

<details style="margin-bottom:2em;">
<summary>Show example</summary>
<pre class="highlight">
<code>
# Start with the CDS Server Metadata's well-known URL, as well as your client_id and client_secret from the initial registration
CDS_METADATA_URL="https://cdsserver123.example.com/.well-known/cds-server-metadata.json"
CLIENT_ID="aaaaaaaaaa"
CLIENT_SECRET="bbbbbbbbbbbbbbb"

# Get the OAuth Token and Clients API endpoints from the OAuth Authorization Server Metadata
OAUTH_METADATA_URL=$(curl "$CDS_METADATA_URL" | jq -r ".oauth_metadata")
OAUTH_METADATA_OBJECT=$(curl "$OAUTH_METADATA_URL" | jq ".")
TOKEN_ENDPOINT=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".token_endpoint")
CDS_CLIENTS_API=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".cds_clients_api")

# Obtain a client_admin access_token
curl -v \
    -u "$CLIENT_ID:$CLIENT_SECRET" \
    -d "grant_type=client_credentials" \
    -d "scope=client_admin" \
    "$TOKEN_ENDPOINT" \
    | jq "."
{
    ...
    "access_token": "cccccccccccccc",
    ...
}
# (extract the access token for use in the Clients API)
CLIENT_ADMIN_ACCESS_TOKEN="cccccccccccccc"

# Get your list of Client objects
curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_CLIENTS_API" \
    | jq "."
{
    "clients": [
        {
            ...
            "cds_client_uri": "...",
            ...
            "client_id": "aaaaaaaaaa",
            ...
            "scope": "client_admin",
            ...
        },
        {
            ...
            "cds_client_uri": "...",
            ...
            "client_id": "aaaaaaaaaa-1",
            ...
            "scope": "grant_admin",
            ...
        },
        {
            ...
            "cds_client_uri": "...",
            ...
            "client_id": "aaaaaaaaaa-2",
            ...
            "scope": "server_provided_files",
            ...
        },
        {
            ...
            "cds_client_uri": "...",
            ...
            "client_id": "aaaaaaaaaa-3",
            ...
            "redirect_uris": ["https://cdsserver123.example.com/receipt"],  # default redirect_uris set by the Server
            ...
            "response_types": ["code"],
            ...
            "scope": "customer_data",
            ...
        }
    ],
    ...
}
</code>
</pre>
</details>

<h4 id="example-adding-a-redirect-uri-to-a-client-object-">Example: Adding a Redirect URI to a Client object <a id="example-modify-redirect-uris" href="#example-modify-redirect-uris" class="permalink">üîó</a></h4>

<p>For Client objects that require user authorization (e.g. <code class="language-plaintext highlighter-rouge">"response_type": ["code"]</code>), you can set your own list of <code class="language-plaintext highlighter-rouge">redirect_uris</code> by modifying the relevant Client object.</p>

<details style="margin-bottom:2em;">
<summary>Show example</summary>
<pre class="highlight">
<code>
# Start with the CDS Server Metadata's well-known URL
# and CLIENT_ADMIN_ACCESS_TOKEN from "Loading the list of Client objects" example
CDS_METADATA_URL="https://cdsserver123.example.com/.well-known/cds-server-metadata.json"
CLIENT_ADMIN_ACCESS_TOKEN="cccccccccccccc"

# Get the Clients API endpoint from the OAuth Authorization Server Metadata
OAUTH_METADATA_URL=$(curl "$CDS_METADATA_URL" | jq -r ".oauth_metadata")
OAUTH_METADATA_OBJECT=$(curl "$OAUTH_METADATA_URL" | jq ".")
CDS_CLIENTS_API=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".cds_clients_api")

# Get the Client object that needs to be updated
CUSTOMER_DATA_CLIENT_OBJECT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_CLIENTS_API" \
    | jq ".clients | .[] | select(.scope==\"customer_data\")")

# Add your own redirect_uri to the current redirect_uris
CUSTOM_REDIRECT_URI="https://example.com/my-redirect"
DEFAULT_REDIRECT_URI=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" | jq -r ".redirect_uris | .[0]")
UPDATED_CUSTOMER_DATA_CLIENT_OBJECT=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" \
    | sed "s|\"$DEFAULT_REDIRECT_URI\"|\"$DEFAULT_REDIRECT_URI\", \"$CUSTOM_REDIRECT_URI\"|g")

# Modify the Client object
CUSTOMER_DATA_CDS_CLIENT_URI=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" | jq -r ".cds_client_uri")
curl -v -X PUT \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    --data-raw "$UPDATED_CUSTOMER_DATA_CLIENT_OBJECT" \
    "$CUSTOMER_DATA_CDS_CLIENT_URI" \
    | jq "."
{
    ...
    "redirect_uris": [
        "https://example.com/my-redirect",          # Your custom redirect_uri
        "https://cdsserver123.example.com/receipt"  # Server's default redirect_uri
    ],
    ...
}

# If you want to revert back to just the Server default, submit an empty list as the redirect_uris
REVERTED_CUSTOMER_DATA_CLIENT_OBJECT="..." # (modified to "redirect_uris": [])
curl -v -X PUT \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    --data-raw "$REVERTED_CUSTOMER_DATA_CLIENT_OBJECT" \
    "$CUSTOMER_DATA_CDS_CLIENT_URI" \
    | jq "."
{
    ...
    "redirect_uris": [
        "https://cdsserver123.example.com/receipt"  # Reverted back to just the Server default
    ],
    ...
}
</code>
</pre>
</details>

<h4 id="example-obtaining-a-user-authorization-">Example: Obtaining a user authorization <a id="example-user-authorization" href="#example-user-authorization" class="permalink">üîó</a></h4>

<p>For Client objects that require user authorization (e.g. <code class="language-plaintext highlighter-rouge">"response_type": ["code"]</code>), use the <code class="language-plaintext highlighter-rouge">authorization_endpoint</code> to obtain an authorization code.</p>

<p>This example assumes you‚Äôve already added your custom <code class="language-plaintext highlighter-rouge">redirect_uri</code> to the relevant Client object‚Äôs <code class="language-plaintext highlighter-rouge">redirect_uris</code>.</p>

<details style="margin-bottom:2em;">
<summary>Show example</summary>
<pre class="highlight">
<code>
# Start with the CDS Server Metadata's well-known URL
# and CLIENT_ADMIN_ACCESS_TOKEN from "Loading the list of Client objects" example
# and CUSTOM_REDIRECT_URI from "Adding a Redirect URI to a Client object" example
CDS_METADATA_URL="https://cdsserver123.example.com/.well-known/cds-server-metadata.json"
CLIENT_ADMIN_ACCESS_TOKEN="cccccccccccccc"
CUSTOM_REDIRECT_URI="https://example.com/my-redirect"

# Get the Authorization, Token, Clients API, and Credentials API endpoints from the OAuth Authorization Server Metadata
OAUTH_METADATA_URL=$(curl "$CDS_METADATA_URL" | jq -r ".oauth_metadata")
OAUTH_METADATA_OBJECT=$(curl "$OAUTH_METADATA_URL" | jq ".")
CDS_CLIENTS_API=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".cds_clients_api")
CDS_CREDENTIALS_API=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".cds_credentials_api")

# Get the Client details to be used for getting authorization
CUSTOMER_DATA_SCOPE="customer_data"
CUSTOMER_DATA_CLIENT_OBJECT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_CLIENTS_API" \
    | jq -r ".clients | .[] | select(.scope==\"$CUSTOMER_DATA_SCOPE\")")
CUSTOMER_DATA_CLIENT_ID=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" | jq -r ".client_id")
CUSTOMER_DATA_CDS_METADATA_URL=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" | jq -r ".cds_server_metadata")
CUSTOMER_DATA_OAUTH_METADATA_URL=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CUSTOMER_DATA_CDS_METADATA_URL" \
    | jq -r ".oauth_metadata")
CUSTOMER_DATA_OAUTH_METADATA_OBJECT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CUSTOMER_DATA_OAUTH_METADATA_URL" \
    | jq ".")
CUSTOMER_DATA_AUTHORIZATION_ENDPOINT=$(echo "$CUSTOMER_DATA_OAUTH_METADATA_OBJECT" | jq -r ".authorization_endpoint")
CUSTOMER_DATA_TOKEN_ENDPOINT=$(echo "$CUSTOMER_DATA_OAUTH_METADATA_OBJECT" | jq -r ".token_endpoint")
CUSTOMER_DATA_ACCOUNTS_ENDPOINT=$(echo "$CUSTOMER_DATA_OAUTH_METADATA_OBJECT" | jq -r ".cds_customerdata_accounts_api")

# Get the client_secret for the Client object that will be used for the authorization
CUSTOMER_DATA_CLIENT_SECRET=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_CREDENTIALS_API?client_ids=$CUSTOMER_DATA_CLIENT_ID" \
    | jq -r ".credentials | .[0] | .client_secret")

# Build the Authorization Request URL
AUTHORIZATION_REQUEST_URL="$CUSTOMER_DATA_AUTHORIZATION_ENDPOINT\
?response_type=code\
&amp;client_id=$CUSTOMER_DATA_CLIENT_ID\
&amp;scope=$CUSTOMER_DATA_SCOPE\
&amp;redirect_uri=$CUSTOM_REDIRECT_URI\
&amp;state=mystatehere"

# (user open's the AUTHORIZATION_REQUEST_URL in a browser and completes the registration)

# (after authorization, the user is redirected back to your custom redirect_uri with and authorization code)
https://example.com/my-redirect?state=mystatehere&amp;code=ddddddddddddd

AUTHORIZATION_CODE="ddddddddddddd"

# Obtain an access_token from the authorization code
curl -v \
    -u "$CUSTOMER_DATA_CLIENT_ID:$CUSTOMER_DATA_CLIENT_SECRET" \
    -d "grant_type=authorization_code" \
    -d "code=$AUTHORIZATION_CODE" \
    -d "redirect_uri=$CUSTOM_REDIRECT_URI" \
    "$CUSTOMER_DATA_TOKEN_ENDPOINT" \
    | jq "."
{
    ...
    "access_token": "eeeeeeeeeeeee",
    ...
}

# (extract the access token for use in the Customer Data API)
CUSTOMER_DATA_ACCESS_TOKEN="eeeeeeeeeeeee"

# make a request to a Customer Data API endpoint
curl -v \
    -H "Authorization: Bearer $CUSTOMER_DATA_ACCESS_TOKEN" \
    "$CUSTOMER_DATA_ACCOUNTS_ENDPOINT" \
    | jq "."
{
    "accounts": [...],
    "next": null,
    "previous": null
}
</code>
</pre>
</details>

<h4 id="example-using-the-grant-admin-scope-to-load-data-for-another-grant-">Example: Using the Grant Admin scope to load data for another Grant <a id="example-grant-admin" href="#example-grant-admin" class="permalink">üîó</a></h4>

<p>You can use the <code class="language-plaintext highlighter-rouge">grant_admin</code> Client object to generate an <code class="language-plaintext highlighter-rouge">access_token</code> that can access data for another Client object‚Äôs Grants.</p>

<p>This is useful for gaining access to data and functionality when Servers create Grants on their side (e.g. the Server-Provided Files API) or when user authorization requests use the Server‚Äôs default <code class="language-plaintext highlighter-rouge">redirect_uri</code> (thus you never get a redirect back with a <code class="language-plaintext highlighter-rouge">code</code>).</p>

<details style="margin-bottom:2em;">
<summary>Show example</summary>
<pre class="highlight">
<code>
# Start with the CDS Server Metadata's well-known URL
# and CLIENT_ADMIN_ACCESS_TOKEN from "Loading the list of Client objects" example
# and CUSTOM_REDIRECT_URI from "Adding a Redirect URI to a Client object" example
CDS_METADATA_URL="https://cdsserver123.example.com/.well-known/cds-server-metadata.json"
CLIENT_ADMIN_ACCESS_TOKEN="cccccccccccccc"
CUSTOM_REDIRECT_URI="https://example.com/my-redirect"

# Get the Authorization, Token, Clients API, and Credentials API endpoints from the OAuth Authorization Server Metadata
OAUTH_METADATA_URL=$(curl "$CDS_METADATA_URL" | jq -r ".oauth_metadata")
OAUTH_METADATA_OBJECT=$(curl "$OAUTH_METADATA_URL" | jq ".")
CDS_CLIENTS_API=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".cds_clients_api")
CDS_CREDENTIALS_API=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".cds_credentials_api")
CDS_GRANTS_API=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".cds_grants_api")

# Get the Client details to be used for getting authorization
CUSTOMER_DATA_SCOPE="customer_data"
CUSTOMER_DATA_CLIENT_OBJECT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_CLIENTS_API" \
    | jq -r ".clients | .[] | select(.scope==\"$CUSTOMER_DATA_SCOPE\")")
CUSTOMER_DATA_CLIENT_ID=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" | jq -r ".client_id")
DEFAULT_REDIRECT_URI=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" | jq -r ".redirect_uris | .[] | select(. != \"$CUSTOM_REDIRECT_URI\")")
CUSTOMER_DATA_CDS_METADATA_URL=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" | jq -r ".cds_server_metadata")
CUSTOMER_DATA_OAUTH_METADATA_URL=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CUSTOMER_DATA_CDS_METADATA_URL" \
    | jq -r ".oauth_metadata")
CUSTOMER_DATA_OAUTH_METADATA_OBJECT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CUSTOMER_DATA_OAUTH_METADATA_URL" \
    | jq ".")
CUSTOMER_DATA_AUTHORIZATION_ENDPOINT=$(echo "$CUSTOMER_DATA_OAUTH_METADATA_OBJECT" | jq -r ".authorization_endpoint")
CUSTOMER_DATA_ACCOUNTS_ENDPOINT=$(echo "$CUSTOMER_DATA_OAUTH_METADATA_OBJECT" | jq -r ".cds_customerdata_accounts_api")

# Build the Authorization Request URL
AUTHORIZATION_REQUEST_URL="$CUSTOMER_DATA_AUTHORIZATION_ENDPOINT\
?response_type=code\
&amp;client_id=$CUSTOMER_DATA_CLIENT_ID\
&amp;scope=$CUSTOMER_DATA_SCOPE\
&amp;redirect_uri=$DEFAULT_REDIRECT_URI\
&amp;state=mystatehere"

# (user open's the AUTHORIZATION_REQUEST_URL in a browser and completes the registration)

# (after authorization, the user is redirected to a Server-hosted receipt page)
https://cdsserver123.example.com/receipts/fffffffffffffffff/

# Get the Grant for the most recent authorization
GRANT_OBJECT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_GRANTS_API?client_ids=$CUSTOMER_DATA_CLIENT_ID" \
    | jq ".grants | .[0]")
GRANT_ID=$(echo "$GRANT_OBJECT" | jq -r ".grant_id")

# Get the grant_admin Client details
GRANT_ADMIN_SCOPE="grant_admin"
GRANT_ADMIN_CLIENT_OBJECT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_CLIENTS_API" \
    | jq -r ".clients | .[] | select(.scope==\"$GRANT_ADMIN_SCOPE\")")
GRANT_ADMIN_CLIENT_ID=$(echo "$GRANT_ADMIN_CLIENT_OBJECT" | jq -r ".client_id")
GRANT_ADMIN_CDS_METADATA_URL=$(echo "$GRANT_ADMIN_CLIENT_OBJECT" | jq -r ".cds_server_metadata")
GRANT_ADMIN_OAUTH_METADATA_URL=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$GRANT_ADMIN_CDS_METADATA_URL" \
    | jq -r ".oauth_metadata")
GRANT_ADMIN_TOKEN_ENDPOINT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$GRANT_ADMIN_OAUTH_METADATA_URL" \
    |jq -r ".token_endpoint")

# Get the client_secret grant_admin Client object
GRANT_ADMIN_CLIENT_SECRET=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_CREDENTIALS_API?client_ids=$GRANT_ADMIN_CLIENT_ID" \
    | jq -r ".credentials | .[0] | .client_secret")

# Create an access_token for the grant using the grant_admin
curl -v \
    -u "$GRANT_ADMIN_CLIENT_ID:$GRANT_ADMIN_CLIENT_SECRET" \
    -d "grant_type=client_credentials" \
    -d "authorization_details=[{
        \"type\": \"$GRANT_ADMIN_SCOPE\",
        \"client_id\": \"$CUSTOMER_DATA_CLIENT_ID\",
        \"grant_id\": \"$GRANT_ID\"
    }]" \
    "$GRANT_ADMIN_TOKEN_ENDPOINT" \
    | jq "."
{
    ...
    "access_token": "gggggggggggggggg",
    ...
}

# (extract the access token for use in the Customer Data API)
GRANT_ADMIN_ACCESS_TOKEN="gggggggggggggggg"

# make a request to a Customer Data API endpoint
curl -v \
    -H "Authorization: Bearer $GRANT_ADMIN_ACCESS_TOKEN" \
    "$CUSTOMER_DATA_ACCOUNTS_ENDPOINT" \
    | jq "."
{
    "accounts": [...],
    "next": null,
    "previous": null
}
</code>
</pre>
</details>

<h4 id="example-providing-a-jwk-in-authorization_details-for-encrypted-responses-">Example: Providing a JWK in authorization_details for encrypted responses <a id="example-auth-details-jwk" href="#example-auth-details-jwk" class="permalink">üîó</a></h4>

<p>When supported, you can provide a JWK public key in the <code class="language-plaintext highlighter-rouge">authorization_details</code> of authorization requests, which triggers encrypting API responses for access granted to be encrypted with that public key.</p>

<p>This is useful for enabling device-level encryption of authorized data, where a device can provide a public key, the user of that device can authorize access, and the data can be encrypted with that device‚Äôs individual public key.</p>

<details style="margin-bottom:2em;">
<summary>Show example</summary>
<pre class="highlight">
<code>
# Start with the CDS Server Metadata's well-known URL
# and CLIENT_ADMIN_ACCESS_TOKEN from "Loading the list of Client objects" example
# and CUSTOM_REDIRECT_URI from "Adding a Redirect URI to a Client object" example
CDS_METADATA_URL="https://cdsserver123.example.com/.well-known/cds-server-metadata.json"
CLIENT_ADMIN_ACCESS_TOKEN="cccccccccccccc"
CUSTOM_REDIRECT_URI="https://example.com/my-redirect"

# Generate elliptical curve JWK (below is an example, DO NOT USE THIS, GENERATE YOUR OWN)
JWK_PRIVATE_KEY='{
    "kty": "EC",
    "crv": "P-256",
    "x": "gI0GAILBdu7T53akrFmMyGcsF3n5dO7MmwNBHKW5SV0",
    "y": "SLW_xSffzlPWrHEVI30DHM_4egVwt3NQqeUD7nMFpps",
    "d": "0_NxaRPUMQoAJt50Gz8YiTr8gRTwyEaCumd-MToTmIo"
}'
JWK_PUBLIC_KEY='{
    "kty": "EC",
    "crv": "P-256",
    "x": "gI0GAILBdu7T53akrFmMyGcsF3n5dO7MmwNBHKW5SV0",
    "y": "SLW_xSffzlPWrHEVI30DHM_4egVwt3NQqeUD7nMFpps"
}'

# Get the Clients and Credentials API endpoints from the OAuth Authorization Server Metadata
OAUTH_METADATA_URL=$(curl "$CDS_METADATA_URL" | jq -r ".oauth_metadata")
OAUTH_METADATA_OBJECT=$(curl "$OAUTH_METADATA_URL" | jq ".")
CDS_CLIENTS_API=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".cds_clients_api")
CDS_CREDENTIALS_API=$(echo "$OAUTH_METADATA_OBJECT" | jq -r ".cds_credentials_api")

# Get the customer data Client details to be used for getting authorization
CUSTOMER_DATA_SCOPE="customer_data"
CUSTOMER_DATA_CLIENT_OBJECT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_CLIENTS_API" \
    | jq -r ".clients | .[] | select(.scope==\"$CUSTOMER_DATA_SCOPE\")")
CUSTOMER_DATA_CLIENT_ID=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" | jq -r ".client_id")
CUSTOMER_DATA_CDS_METADATA_URL=$(echo "$CUSTOMER_DATA_CLIENT_OBJECT" | jq -r ".cds_server_metadata")
CUSTOMER_DATA_OAUTH_METADATA_URL=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CUSTOMER_DATA_CDS_METADATA_URL" \
    | jq -r ".oauth_metadata")
CUSTOMER_DATA_OAUTH_METADATA_OBJECT=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CUSTOMER_DATA_OAUTH_METADATA_URL" \
    | jq ".")
CUSTOMER_DATA_AUTHORIZATION_ENDPOINT=$(echo "$CUSTOMER_DATA_OAUTH_METADATA_OBJECT" | jq -r ".authorization_endpoint")
CUSTOMER_DATA_TOKEN_ENDPOINT=$(echo "$CUSTOMER_DATA_OAUTH_METADATA_OBJECT" | jq -r ".token_endpoint")
CUSTOMER_DATA_PAR_ENDPOINT=$(echo "$CUSTOMER_DATA_OAUTH_METADATA_OBJECT" | jq -r ".pushed_authorization_request_endpoint")
CUSTOMER_DATA_ACCOUNTS_ENDPOINT=$(echo "$CUSTOMER_DATA_OAUTH_METADATA_OBJECT" | jq -r ".cds_customerdata_accounts_api")

# Get the client_secret for the Client object that will be used for the authorization
CUSTOMER_DATA_CLIENT_SECRET=$(curl -v \
    -H "Authorization: Bearer $CLIENT_ADMIN_ACCESS_TOKEN" \
    "$CDS_CREDENTIALS_API?client_ids=$CUSTOMER_DATA_CLIENT_ID" \
    | jq -r ".credentials | .[0] | .client_secret")

# Create a Pushed-Authorization Request request_uri with the JWK in authorization_details
PAR_REQUEST_URI=$(curl -v \
    -u "$CUSTOMER_DATA_CLIENT_ID:$CUSTOMER_DATA_CLIENT_SECRET" \
    -d "response_type=code" \
    -d "authorization_details=[{\"type\": \"$CUSTOMER_DATA_SCOPE\", \"jwk\": $JWK_PUBLIC_KEY}]" \
    -d "redirect_uri=$CUSTOM_REDIRECT_URI" \
    -d "state=mystatehere" \
    "$CUSTOMER_DATA_PAR_ENDPOINT" \
    | jq -r ".request_uri")

# Build the Authorization Request URL
AUTHORIZATION_REQUEST_URL="$CUSTOMER_DATA_AUTHORIZATION_ENDPOINT\
?client_id=$CUSTOMER_DATA_CLIENT_ID\
&amp;request_uri=$PAR_REQUEST_URI"

# (user open's the AUTHORIZATION_REQUEST_URL in a browser and completes the registration)

# (after authorization, the user is redirected back to your custom redirect_uri with and authorization code)
https://example.com/my-redirect?state=mystatehere&amp;code=ddddddddddddd

AUTHORIZATION_CODE="ddddddddddddd"

# Obtain an access_token from the authorization code
curl -v \
    -u "$CUSTOMER_DATA_CLIENT_ID:$CUSTOMER_DATA_CLIENT_SECRET" \
    -d "grant_type=authorization_code" \
    -d "code=$AUTHORIZATION_CODE" \
    -d "redirect_uri=$CUSTOM_REDIRECT_URI" \
    "$CUSTOMER_DATA_TOKEN_ENDPOINT" \
    | jq "."
{
    ...
    "access_token": "eeeeeeeeeeeee",
    ...
}

# (extract the access token for use in the Customer Data API)
CUSTOMER_DATA_ACCESS_TOKEN="eeeeeeeeeeeee"

# Make a request to get the data from the APIs
ENCRYPTED_HEADERS_AND_BODY=$(curl -v --include \
    -H "Authorization: Bearer $CUSTOMER_DATA_ACCESS_TOKEN" \
    "$CUSTOMER_DATA_ACCOUNTS_ENDPOINT")

# Example decrypting data using python's cryptography library
```
    import json
    from struct import pack
    from base64 import urlsafe_b64decode
    from cryptography.hazmat.primitives import hashes
    from cryptography.hazmat.primitives.kdf import concatkdf
    from cryptography.hazmat.primitives.asymmetric import ec
    from cryptography.hazmat.primitives.ciphers import aead

    # the encrypted response from the server
    RESPONSE_HEADERS = {
        "X-CDS-Header-JWE-Protected-Header": (
            "eyJhbGciOiAiRUNESC1FUyIsICJlbmMiOiAiQTI1NkdDTSIsICJlcGsiOiB7ImNydiI6ICJQLTI1NiIs"
            "ICJrdHkiOiAiRUMiLCAieCI6ICJIYlB1c0xxYktPbWFyQ3F1LUZYLWFiZ0FEbG10Y0xvYWRLaU41Yi1F"
            "U05ZIiwgInkiOiAiOHFCRE9KamMtdWZPOWl6UU1QMmw5cjhBREhfdUlUM29JMmpQaUozUXRJRSJ9fQ"
        ),
        "X-CDS-Header-JWE-Initialization-Vector": "7yhXitQOQAXeSUUp",
        "X-CDS-Header-JWE-Ciphertext": "GHyB5gkubIRA1OJYdxRGMXianidlLP0aBeYUAFZqooXeOlL4ckxUMR2HZQW5NZ2A8acJi3s",
        "X-CDS-Header-JWE-Authentication-Tag": "3fxjpNO4vgbgYsedo6srVA",
        "X-CDS-Body-JWE-Protected-Header": (
            "eyJhbGciOiAiRUNESC1FUyIsICJlbmMiOiAiQTI1NkdDTSIsICJlcGsiOiB7ImNydiI6ICJQLTI1NiIs"
            "ICJrdHkiOiAiRUMiLCAieCI6ICJGWDVjTnJjMkZoUjlMa0dfeTUwR0FKbzJFalZCc3FSQ2dGVjNRcWZj"
            "dm5vIiwgInkiOiAiTXRySWZuYnJHUnlnVWd6RVJlTnl4SENXa3ByaHUzUWo5TnRJdkpMVlFDVSJ9fQ"
        ),
        "X-CDS-Body-JWE-Initialization-Vector": "50q7kpETagvHqEBI",
    }
    RESPONSE_BODY = (
        b"G\x9aN\xcb\x88\x1f|@\xaa\x9du\x9a\xc6\x82x\xe8\x93\xb7S\xdeq\x1b"
        b"\x9d\xd3\xa1\x8b\xb3\xa9\x96n.'\xa8D\x86~\xfa\x00g\xd0'Y\x9b\x85"
        b"\xf2\r_\xab\xd4\x1e\xd9[\xfc\x03\x1d\xb50z\xfb\xa4 \xfeH\xd0"
    )

    # previously generated EC private key
    JWK_PRIVATE_KEY = {
        "kty": "EC",
        "crv": "P-256",
        "x": "gI0GAILBdu7T53akrFmMyGcsF3n5dO7MmwNBHKW5SV0",
        "y": "SLW_xSffzlPWrHEVI30DHM_4egVwt3NQqeUD7nMFpps",
        "d": "0_NxaRPUMQoAJt50Gz8YiTr8gRTwyEaCumd-MToTmIo"
    }

    # compose python private key from JWK_PRIVATE_KEY
    x = int.from_bytes(urlsafe_b64decode((JWK_PRIVATE_KEY["x"] + "===").encode()), byteorder="big")
    y = int.from_bytes(urlsafe_b64decode((JWK_PRIVATE_KEY["y"] + "===").encode()), byteorder="big")
    d = int.from_bytes(urlsafe_b64decode((JWK_PRIVATE_KEY["d"] + "===").encode()), byteorder="big")
    priv_key = ec.EllipticCurvePrivateNumbers(d, ec.EllipticCurvePublicNumbers(x, y, ec.SECP256R1())).private_key()

    # decode the public keys the response's encrypted headers
    headers_aad = RESPONSE_HEADERS["X-CDS-Header-JWE-Protected-Header"].encode()
    headers_jwe = json.loads(urlsafe_b64decode(headers_aad + b"==="))
    assert headers_jwe["alg"] == "ECDH-ES"
    assert headers_jwe["enc"] == "A256GCM"
    headers_x = int.from_bytes(urlsafe_b64decode((headers_jwe["epk"]["x"] + "===").encode()), byteorder="big")
    headers_y = int.from_bytes(urlsafe_b64decode((headers_jwe["epk"]["y"] + "===").encode()), byteorder="big")
    headers_pubkey = ec.EllipticCurvePublicNumbers(headers_x, headers_y, ec.SECP256R1()).public_key()

    # decode the public keys the response's encrypted body
    body_aad = RESPONSE_HEADERS["X-CDS-Body-JWE-Protected-Header"].encode()
    body_jwe = json.loads(urlsafe_b64decode(body_aad + b"==="))
    assert body_jwe["alg"] == "ECDH-ES"
    assert body_jwe["enc"] == "A256GCM"
    body_x = int.from_bytes(urlsafe_b64decode((body_jwe["epk"]["x"] + "===").encode()), byteorder="big")
    body_y = int.from_bytes(urlsafe_b64decode((body_jwe["epk"]["y"] + "===").encode()), byteorder="big")
    body_pubkey = ec.EllipticCurvePublicNumbers(body_x, body_y, ec.SECP256R1()).public_key()

    # calculate the JWE ephemeral AES-GCM key for the encrypted headers
    headers_shared_key = priv_key.exchange(ec.ECDH(), headers_pubkey)
    headers_algid = headers_jwe["enc"].encode()
    headers_apu = urlsafe_b64decode((headers_jwe["apu"] + "===").encode()) if "apu" in headers_jwe else b""
    headers_apv = urlsafe_b64decode((headers_jwe["apv"] + "===").encode()) if "apv" in headers_jwe else b""
    headers_other_info = b"".join([
        pack("!I", len(headers_algid)), headers_algid,
        pack("!I", len(headers_apu)), headers_apu,
        pack("!I", len(headers_apv)), headers_apv,
        pack("!I", 256),
    ])
    headers_ckdf = concatkdf.ConcatKDFHash(hashes.SHA256(), 256 // 8, headers_other_info)
    headers_aes_key = headers_ckdf.derive(headers_shared_key)

    # calculate the JWE ephemeral AES-GCM key for the encrypted body
    body_shared_key = priv_key.exchange(ec.ECDH(), body_pubkey)
    body_algid = body_jwe["enc"].encode()
    body_apu = urlsafe_b64decode((body_jwe["apu"] + "===").encode()) if "apu" in body_jwe else b""
    body_apv = urlsafe_b64decode((body_jwe["apv"] + "===").encode()) if "apv" in body_jwe else b""
    body_other_info = b"".join([
        pack("!I", len(body_algid)), body_algid,
        pack("!I", len(body_apu)), body_apu,
        pack("!I", len(body_apv)), body_apv,
        pack("!I", 256),
    ])
    body_ckdf = concatkdf.ConcatKDFHash(hashes.SHA256(), 256 // 8, body_other_info)
    body_aes_key = body_ckdf.derive(body_shared_key)

    # decrypt the headers (NOTE: need to concatinate ciphertext and authentication tag for data to decrypt)
    headers_iv = urlsafe_b64decode((RESPONSE_HEADERS["X-CDS-Header-JWE-Initialization-Vector"] + "===").encode())
    headers_ciphertext = urlsafe_b64decode((RESPONSE_HEADERS["X-CDS-Header-JWE-Ciphertext"] + "===").encode())
    headers_tag = urlsafe_b64decode((RESPONSE_HEADERS["X-CDS-Header-JWE-Authentication-Tag"] + "===").encode())
    headers_cleartext = aead.AESGCM(headers_aes_key).decrypt(headers_iv, headers_ciphertext + headers_tag, headers_aad)

    # decrypt the body (NOTE: authentication tag is already appended to the end of the response)
    body_iv = urlsafe_b64decode((RESPONSE_HEADERS["X-CDS-Body-JWE-Initialization-Vector"] + "===").encode())
    body_cleartext = aead.AESGCM(body_aes_key).decrypt(body_iv, RESPONSE_BODY, body_aad)

    # print the results
    # (encrypted headers = 'Content-Type: application/json\nX-Log-ID: 123456abcdef')
    # (encrypted body = '{"accounts":[], "next": null, "previous": null}')
    print("Headers:")
    for header_row in headers_cleartext.decode().split("\n"):
        print(header_row)
    print("Body:")
    print(body_cleartext)
```
</code>
</pre>
</details>
<hr />

<h1 id="other-drafts-">Other Drafts <a id="other-drafts" href="#other-drafts" class="permalink">üîó</a></h1>

<ul>
  <li>Maintainer‚Äôs draft: [<a href="https://daniel-roesler.github.io/CDS-Registration/specs/cds-wg1-02/overview">Website</a>] [<a href="https://github.com/daniel-roesler/CDS-Registration/blob/main/website/specs/cds-wg1-02/overview.md">Code</a>]</li>
</ul>


                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-light pt-5 pb-5">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <h4>CDS Registration Working Group:</h4>
                        <ul>
                            <li>
                                <a href="/CDS-Registration/"
                                    >Working Group website</a>
                                (this website!)
                            </li>
                            <li>
                                <a href="/CDS-Registration/use-cases"
                                    >Use Cases</a>
                            </li>
                            <li>
                                <a href="/CDS-Registration/specs"
                                    >Specifications</a>
                            </li>
                            <li>
                                <a href="https://github.com/lfe-cds/CDS-Registration" target="_blank"
                                    >Github Repository
                                    <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                            </li>
                            <li>
                                <a href="https://github.com/lfe-cds/CDS-Registration/tree/main/meetings" target="_blank"
                                    >Meeting Minutes
                                    <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                            </li>
                            <li>
                                <a href="https://github.com/lfe-cds/CDS-Registration/pulls" target="_blank"
                                    >Active Pull Requests
                                    <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                            </li>
                            <li>
                                <a href="https://lists.lfenergy.org/g/cds-registration-wg" target="_blank"
                                    >Mailing List
                                    <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                            </li>
                            <li>
                                <a href="https://lists.lfenergy.org/g/cds-registration-wg/calendar" target="_blank"
                                    >Event Calendar
                                    <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                            </li>
                            <li>
                                <a href="https://slack.lfenergy.org/" target="_blank"
                                    >Slack
                                    <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                                (channel: <code>#cds-registration-wg</code>)
                            </li>
                        </ul>
                    </div>
                    <div class="col">
                        <h4>CDS / Linux Foundation:</h4>
                        <ul>
                            <li>
                                <a href="https://www.linuxfoundation.org/" target="_blank"
                                    >Linux Foundation
                                    <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                                <ul>
                                    <li>
                                        <a href="https://www.lfenergy.org/" target="_blank"
                                            >LF Energy
                                            <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                                        <ul>
                                            <li>
                                                <a href="https://cds.lfenergy.org" target="_blank"
                                                    >Connected Data Specification (CDS)
                                                    <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                                                <ul>
                                                    <li>
                                                        <a href="https://github.com/lfe-cds/CDS-Registration" target="_blank"
                                                            >CDS Registration Working Group (WG1)
                                                            <svg class="svgicon"><use href="#fa-external-link"/></svg></a> (i.e. this working group)
                                                    </li>
                                                    <li>
                                                        <a href="https://github.com/lfe-cds/CDS-Power-Systems-Data" target="_blank"
                                                            >CDS Power Systems Data Working Group (WG2)
                                                            <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                                                    </li>
                                                    <li>
                                                        <a href="https://github.com/lfe-cds/CDS-Customer-Data" target="_blank"
                                                            >CDS Customer Data Working Group (WG3)
                                                            <svg class="svgicon"><use href="#fa-external-link"/></svg></a>
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Scripts -->
        <script src="/CDS-Registration/assets/bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js"></script>
        
        
    </body>
</html>

